package com.github.kolandroid.kol.android.controller;

import android.view.View;

import androidx.annotation.CallSuper;
import androidx.annotation.Nullable;

import com.github.kolandroid.kol.android.screen.Screen;
import com.github.kolandroid.kol.model.Model;
import com.github.kolandroid.kol.util.Logger;

import java.lang.ref.WeakReference;

public abstract class UpdatableModelController<M extends Model> extends ModelController<M> implements UpdatableController {
    /**
     * Autogenerated by eclipse.
     */
    private static final long serialVersionUID = 8000096303272331462L;

    private transient WeakReference<Screen> currentScreen;
    private transient WeakReference<View> currentView;

    public UpdatableModelController(M model) {
        super(model);

        this.currentView = new WeakReference<>(null);
        this.currentScreen = new WeakReference<>(null);
    }

    @CallSuper
    @Override
    public void connect(View view, Screen host) {
        super.connect(view, host);
        this.currentView = new WeakReference<>(view);
        this.currentScreen = new WeakReference<>(host);
    }

    @CallSuper
    @Override
    public void disconnect(Screen host) {
        super.disconnect(host);
        this.currentView = new WeakReference<>(null);
        this.currentScreen = new WeakReference<>(null);
    }

    protected final void doReplace(M model) {
        if (currentView == null || currentScreen == null) {
            doReplace(model, null, null);
        } else {
            doReplace(model, currentView.get(), currentScreen.get());
        }
    }

    protected void doReplace(M model, @Nullable View view, @Nullable Screen screen) {
        if (view != null && screen != null) {
            disconnect(screen);
            attach(view, screen);
            connect(view, screen);
            view.invalidate();
        }
    }

    @Override
    public <F> boolean tryApply(Class<F> type, F object) {
        Logger.log("UpdatableModelController", "Update: " + type + ", Current: " + getModel().getClass());
        if (getModel().getClass().equals(type)) {
            M newModel = (M) object;
            this.setModel(newModel);
            doReplace(newModel);
            return true;
        }
        return false;
    }
}
